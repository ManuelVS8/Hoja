<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>La Hoja - Partes de la hoja</title>
    <style>
        /* ====== Reset & base ====== */
        * { box-sizing: border-box; margin:0; padding:0; }
        :root{
            --blue:#001DFF;
            --blue-dark:#04032B;
            --blue-700:#1a3a5f;
            --blue-600:#254fba;
            --orange:#f59e42;
            --orange-700:#e67e22;
            --bg-grad-1:#1a3a5f;
            --bg-grad-2:#0d2340;
            --white:#ffffff;
            --green:#2ecc71;
            --red:#e74c3c;
            --panel:#E8EAFF;
        }
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
            min-height:100vh; display:flex; justify-content:center; align-items:center; color:#333; padding:10px;
        }
        .game-container{
            background:var(--white); border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.12);
            padding:1.2rem; max-width:980px; width:100%; min-height:640px; position:relative; overflow:hidden;
            display:flex; flex-direction:column;
        }
        header{ text-align:center; margin-bottom:.8rem; margin-top:1.5rem; }
        h1{ color:var(--blue-dark); font-size:clamp(2rem,5.2vw,3.1rem); font-weight:900; letter-spacing:.5px; }
        .subtitle{ color:var(--blue-700); font-size:clamp(1rem,3.5vw,1.25rem); margin-top:.25rem; }
        .highlight-keyword{ color:var(--orange); font-weight:800; }

        .btn{ color:#fff; border:none; padding:.75rem 1.2rem; border-radius:10px; cursor:pointer; font-weight:800;
            transition:transform .08s ease, box-shadow .2s ease, background-color .25s ease; min-width:140px; height:48px;
            display:inline-flex; align-items:center; justify-content:center; font-size: 1rem; }
        .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.12); }
        .btn:active{ transform:translateY(0); }
        .btn-primary{ background:var(--orange); }
        .btn-primary:hover{ background:var(--orange-700); }
        .btn-blue{ background:var(--blue-600); }
        .btn-blue:hover{ filter:brightness(.9); }
        .btn-ghost{ background:#e6f2ff; color:var(--blue-700); }

        .screen{ display:none; animation:fadeIn .35s ease; flex-direction:column; flex:1; }
        .screen.active{ display:flex; }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(12px);} to{opacity:1; transform:translateY(0);} }

        .game-info{ display:flex; gap:.6rem; align-items:center; justify-content:space-between; margin:.4rem 0 1rem; flex-wrap:wrap; }
        .timer{ font-weight:900; color:var(--blue-700); font-size:clamp(.95rem,2.3vw,1.15rem); }
        .progress-bar{ flex:1; height:10px; background:#e6f2ff; border-radius:999px; overflow:hidden; }
        .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--orange) 0%, var(--orange-700) 100%); transition:width .3s ease; }

        /* Pantalla Inicio Est√©tica */
        .start-content{ display:flex; flex-direction:column; justify-content:center; align-items:center; flex:1; gap:1rem; padding:1rem; }
        .advice-box{ background:var(--panel); border-left:4px solid var(--blue-700); padding:1rem 1.2rem; border-radius:12px;
            color:var(--blue-700); max-width:760px; text-align:center; font-size:clamp(1rem,3vw,1.15rem); }
        .start-image{ max-width: 300px; width: 100%; margin: 0 auto; }
        
        .mute-btn{ position:absolute; top:.8rem; right:4.5rem; background:var(--orange); color:#fff; border:2px solid #fff; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; z-index:20; }
        .mute-btn:hover{ background:var(--orange-700); }

        /* Juego 1 (Tarjetas) */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        @media (max-width: 600px) { .cards-container { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); } }

        .memory-card {
            background-color: #3498db;
            color: white;
            border: 3px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            user-select: none;
        }
        .memory-card:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .memory-card.selected { background-color: #f1c40f; transform: scale(1.05); }
        .memory-card.matched { background-color: #27ae60; color: white; cursor: default; }
        
        /* Feedback visual r√°pido para errores (sin retardo de bloqueo) */
        .memory-card.flash-error {
            animation: shakeRed 0.3s ease-in-out;
        }
        @keyframes shakeRed {
            0% { background-color: #3498db; transform: translateX(0); }
            20% { background-color: #e74c3c; transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { background-color: #3498db; transform: translateX(0); }
        }

        /* Juego 2 (Se√±alar) */
        .game-instruction { font-size: 1.5rem; color: var(--blue); margin: 10px 0; font-weight: bold; text-align: center; }
        .game2-wrapper { position: relative; max-width: 500px; margin: 0 auto; width: 100%; }
        .image-wrapper { position: relative; width: 100%; padding-top: 103.8%; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .image-wrapper img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        
        .selection-box {
            position: absolute;
            background-color: #FFFFFF; 
            border: 3px solid #000000; 
            cursor: pointer;
            transition: background-color 0.1s ease, transform 0.1s ease; 
        }

        /* Animaciones de Feedback Visual para Juego 2 */
        .selection-box.correct-flash {
            animation: flashGreen 0.3s ease-in-out;
        }
        .selection-box.wrong-flash {
            animation: flashRed 0.3s ease-in-out;
        }

        @keyframes flashGreen {
            0% { background-color: #FFFFFF; border-color: #000000; transform: scale(1); }
            50% { background-color: #2ecc71; border-color: #2ecc71; transform: scale(1.1); }
            100% { background-color: #FFFFFF; border-color: #000000; transform: scale(1); }
        }

        @keyframes flashRed {
            0% { background-color: #FFFFFF; border-color: #000000; transform: translateX(0); }
            25% { background-color: #e74c3c; border-color: #e74c3c; transform: translateX(5px); }
            75% { background-color: #e74c3c; border-color: #e74c3c; transform: translateX(-5px); }
            100% { background-color: #FFFFFF; border-color: #000000; transform: translateX(0); }
        }

        /* Pantalla Final */
        .results{ display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; flex:1; justify-content:center;}
        .final-title{ color:var(--blue-dark); font-weight:900; }
        .big-score{ font-size:clamp(2.2rem,6vw,3.4rem); color:var(--blue-600); font-weight:900; }
        .score-title{ font-size:1.0rem; color:var(--blue-700); margin-top:1rem; }
        .final-time{ color:var(--blue-700); }
        .trophy{ font-size:clamp(4rem,10vw,6rem); margin:.2rem 0; color:var(--orange); animation:bounce 1s ease infinite; display:none; }
        @keyframes bounce { 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-8px);} }
        .credit{ color:var(--blue-700); margin-top:1rem; }
        
        #finalMsg { font-size: clamp(1.2rem, 4.2vw, 1.8rem); font-weight: 800; color: var(--blue-700); margin-top: 0.6rem; }
        
        .school-logo { display: block; width: 160px; max-width: 28%; height: auto; margin-top: 0.8rem; border-radius: 8px; object-fit: contain; }
        @media (max-width: 899px) { .school-logo { width: 140px; max-width: 160px; } }
        @media (max-width: 420px) { .school-logo { width: 110px; max-width: 40%; margin-top: 0.6rem; } }

        /* --- ESTILOS DEL HALL OF FAME (PROMPT INICIAL) --- */
        .hall-of-fame {
            background: var(--panel);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
            width: 100%;
            max-width: 600px;
        }

        .hall-of-fame-title {
            color: var(--blue-700);
            font-weight: 800;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 0.8rem;
        }

        .hall-of-fame-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .hall-of-fame-table th {
            background: var(--blue-600);
            color: white;
            padding: 0.5rem;
            text-align: left;
        }

        .hall-of-fame-table td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #ddd;
        }

        .hall-of-fame-table tr:last-child td {
            border-bottom: none;
        }

        .hall-of-fame-table tr:nth-child(even) {
            background-color: rgba(255, 255,255, 0.5);
        }

        .hall-of-fame-error, .hall-of-fame-loading {
            padding: 1rem;
            text-align: center;
            color: var(--blue-700);
            font-style: italic;
        }

        .hall-of-fame-error {
            color: var(--red);
        }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal-content { background:white; padding:2rem; border-radius:15px; width:90%; max-width:400px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
        .modal-input { width:100%; padding:10px; margin:10px 0; border:2px solid #ddd; border-radius:8px; font-size:1rem; }
        
        .confetti{ position:fixed; width:10px; height:10px; border-radius:50%; animation: confetti-fall 3s linear forwards; z-index:999; }
        @keyframes confetti-fall{ 0%{ transform:translate(0, -20px) rotate(0); opacity:1;} 100%{ transform:translate(var(--tx), var(--ty)) rotate(360deg); opacity:0; } }

        /* Pantalla Resumen */
        .theory-content { background-color: #f8f9fa; padding: 25px; border-radius: 15px; margin: 25px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-left: 6px solid var(--blue); }
        .system-item { margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(240,245,255,0.9)); border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); border-left: 4px solid var(--orange); }
        .system-name { color: var(--blue); font-size: 1.2rem; font-weight: 800; margin-bottom: 5px; display: flex; align-items: center; }
        .system-name::before { content: '‚ñ∏'; color: var(--orange); font-size: 1.5rem; margin-right: 10px; }
    </style>
</head>
<body>
<div class="game-container">
    <button class="mute-btn" id="muteBtn" title="Silenciar/Activar sonido">üîä</button>

    <!-- PANTALLA INICIO -->
    <section class="screen active" id="startScreen">
        <header>
            <h1>La hoja</h1>
            <div class="subtitle">Las partes de la hoja</div>
        </header>
        <div class="start-content">
            <div class="advice-box">
                <span class="advice-text">Estudia las <span class="highlight-keyword">partes de la hoja</span> e identifica d√≥nde se encuentran.</span>
                <strong style="display:block; margin-top:0.5rem;">¬°√Ånimo!</strong>
            </div>
            <button class="btn btn-primary" id="playBtn">Comenzar a aprender</button>
            <img class="start-image" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Ni%C3%B1os.png" alt="Ni√±os aprendiendo">
            
            <!-- Hall of Fame (ID y Clases seg√∫n Prompt Inicial) -->
            <div class="hall-of-fame" id="hallOfFame">
                <div class="hall-of-fame-title">üèÜ Mejores puntuaciones üèÜ</div>
                <table class="hall-of-fame-table">
                    <thead>
                        <tr>
                            <th>Posici√≥n</th>
                            <th>Nombre</th>
                            <th>Puntos</th>
                            <th>Tiempo</th>
                        </tr>
                    </thead>
                    <tbody id="hofTableBody">
                        <tr><td colspan="4" class="hall-of-fame-loading">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- PANTALLA RESUMEN -->
    <section class="screen" id="summaryScreen">
        <header>
            <h1>Estudia las partes de la hoja</h1>
        </header>
        <div class="theory-content">
            <div class="system-item"><div class="system-name">Peciolo</div>Parte de la hoja que est√° unida al tallo.</div>
            <div class="system-item"><div class="system-name">Haz</div>Parte superior de la hoja.</div>
            <div class="system-item"><div class="system-name">Env√©s</div>Parte inferior de la hoja.</div>
            <div class="system-item"><div class="system-name">Nervios</div>Conductos por donde circula la savia.</div>
            <div class="system-item"><div class="system-name">Limbo</div>Es la hoja sin contar el peciolo.</div>
        </div>
        <div style="text-align: center;">
            <button class="btn btn-primary" id="startGame1Btn">Jugar</button>
        </div>
    </section>

    <!-- PANTALLA JUEGO 1 -->
    <section class="screen" id="game1Screen">
        <header>
            <h1>Empareja las partes de la hoja</h1>
        </header>
        <div class="game-info">
            <div class="timer" id="timerGame1">00:00.0</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFillGame1"></div></div>
            <div class="timer" style="font-size:0.9rem;">Intentos: <span id="attemptsGame1">0</span></div>
        </div>
        <div class="cards-container" id="cardsContainerGame1"></div>
    </section>

    <!-- PANTALLA JUEGO 2 -->
    <section class="screen" id="game2Screen">
        <header>
            <h1>Identifica las partes de la hoja</h1>
        </header>
        <div class="game-info">
            <div class="timer" id="timerGame2">00:00.0</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFillGame2"></div></div>
            <div class="timer" style="font-size:0.9rem;">Intentos: <span id="attemptsGame2">0</span></div>
        </div>
        <div class="game-instruction" id="targetDisplay">Busca: Peciolo</div>
        <div class="game2-wrapper">
            <div class="image-wrapper" id="imageWrapperGame2">
                <img src="https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Animales_y_Plantas/hoja.png" alt="Hoja para se√±alar">
                <!-- Casillas generadas por JS -->
            </div>
        </div>
    </section>

    <!-- PANTALLA FINAL -->
    <section class="screen" id="finalScreen">
        <header>
            <h1 class="final-title">Partes de la hoja</h1>
        </header>
        <div class="results">
            <div id="trophyBox" style="display:none;"><div class="trophy">üèÜ</div></div>
            <div class="score-title">Tu puntuaci√≥n:</div>
            <div class="big-score" id="finalScore">0</div>
            <div class="final-time">Tiempo: <span id="finalTime">00:00.0</span></div>
            <div id="finalMsg" class="subtitle"></div>
            <button class="btn btn-primary" id="backToMenuBtn" style="background:var(--orange);">Volver al men√∫</button>
            <span class="credit">Created by Manuel J. Ventura</span>
            <img class="school-logo" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Siurot.png" alt="Logo del colegio" />
        </div>
    </section>
</div>

<!-- MODAL (ID submitModal) -->
<div id="submitModal" class="modal-overlay">
    <div class="modal-content">
        <h3>¬°Juego Terminado!</h3>
        <p>Tu tiempo: <span id="modalTime">00:00.0</span></p>
        <input type="text" id="playerName" class="modal-input" placeholder="Nombre" maxlength="15">
        <input type="text" id="playerSurname" class="modal-input" placeholder="Apellido" maxlength="20">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="submitScoreBtn" class="btn btn-primary">Guardar</button>
            <button id="discardScoreBtn" class="btn btn-ghost">Cancelar</button>
        </div>
    </div>
</div>

<script>
    /* --- 1. CONFIGURACI√ìN DE VARIABLES GLOBALES (CR√çTICO) --- */
    const SHEET_NAME = "Hoja";
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbu0fcjUhXKQ0sbUkNOx4YhfUno7mif5clU3lBipogFsCtq7UytDrEW8NbTXBvM0LCPQ/exec";
    
    let soundEnabled = true;
    let audioUnlocked = false;
    let startTime = 0;
    let timerInterval = null;
    
    // Contadores de intentos
    let attemptsGame1 = 0;
    let attemptsGame2 = 0;
    const correctPairsGame1 = 5;
    const correctPairsGame2 = 5;

    const audioUrls = {
        correct: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Correcto.mp3',
        error: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Error.mp3',
        tap: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3',
        victory: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Termin%C3%A9.mp3',
        completed: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Completado.mp3'
    };
    const audioObjects = {};
    Object.keys(audioUrls).forEach(key => { audioObjects[key] = new Audio(audioUrls[key]); });

    function unlockAudio() {
        if (audioUnlocked) return;
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination); g.gain.value = 0.001;
            osc.start(); osc.stop(ctx.currentTime + 0.01);
            audioUnlocked = true;
        } catch(e) { audioUnlocked = true; }
    }

    function playSound(type) {
        if (!soundEnabled || !audioObjects[type]) return;
        if (!audioUnlocked) unlockAudio();
        try { audioObjects[type].currentTime = 0; audioObjects[type].play(); } catch(e){}
    }

    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('muteBtn').textContent = soundEnabled ? 'üîä' : 'üîá';
    }

    /* --- DATOS DEL JUEGO --- */
    const game1Data = [
        { id: 'peciolo', term: 'Peciolo', def: 'Parte que une la hoja al tallo' },
        { id: 'haz', term: 'Haz', def: 'Parte superior de la hoja' },
        { id: 'enves', term: 'Env√©s', def: 'Parte inferior de la hoja' },
        { id: 'nervios', term: 'Nervios', def: 'Conductos que transportan la savia' },
        { id: 'limbo', term: 'Limbo', def: 'Parte de la hoja sin contar el peciolo' }
    ];

    const game2Targets = [
        { id: 'peciolo', name: 'Peciolo', x1: 108, y1: 746, x2: 344, y2: 942 },
        { id: 'haz', name: 'Haz', x1: 637, y1: 38, x2: 872, y2: 235 },
        { id: 'enves', name: 'Env√©s', x1: 422, y1: 595, x2: 657, y2: 791 },
        { id: 'nervios', name: 'Nervios', x1: 28, y1: 15, x2: 257, y2: 209 },
        { id: 'limbo', name: 'Limbo', x1: 686, y1: 641, x2: 913, y2: 834 }
    ];

    /* --- L√ìGICA GENERAL --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startTimer(displayId) {
        stopTimer();
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsed = (Date.now() - startTime) / 1000;
            const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const s = Math.floor(elapsed % 60).toString().padStart(2, '0');
            const ms = Math.floor((elapsed % 1) * 10);
            document.getElementById(displayId).textContent = `${m}:${s}.${ms}`;
        }, 100);
    }

    function stopTimer() {
        if (timerInterval) clearInterval(timerInterval);
    }

    function formatTime(sec) {
        const m = Math.floor(sec / 60).toString().padStart(2, '0');
        const s = Math.floor(sec % 60).toString().padStart(2, '0');
        const ms = Math.floor((sec % 1) * 10);
        return `${m}:${s}.${ms}`;
    }

    /* --- JUEGO 1 --- */
    let selectedCards = [];
    let matchesFound = 0;

    function initGame1() {
        const container = document.getElementById('cardsContainerGame1');
        container.innerHTML = '';
        selectedCards = [];
        matchesFound = 0;
        attemptsGame1 = 0; 
        document.getElementById('attemptsGame1').textContent = '0';
        updateProgress('progressFillGame1', 0);
        startTimer('timerGame1');

        let cards = [];
        game1Data.forEach(p => { cards.push(p.term, p.def); });
        cards.sort(() => Math.random() - 0.5);

        cards.forEach(text => {
            const el = document.createElement('div');
            el.className = 'memory-card';
            el.textContent = text;
            el.onclick = () => selectCard(el);
            container.appendChild(el);
        });
    }

    function selectCard(card) {
        if (card.classList.contains('matched') || selectedCards.length >= 2 || selectedCards.includes(card)) return;
        
        playSound('tap');
        card.classList.add('selected');
        selectedCards.push(card);

        if (selectedCards.length === 2) {
            attemptsGame1++;
            document.getElementById('attemptsGame1').textContent = attemptsGame1;

            const c1 = selectedCards[0];
            const c2 = selectedCards[1];
            const pair1 = game1Data.find(p => p.term === c1.textContent);
            const pair2 = game1Data.find(p => p.term === c2.textContent);

            let isMatch = false;
            if (pair1 && pair1.def === c2.textContent) isMatch = true;
            else if (pair2 && pair2.def === c1.textContent) isMatch = true;

            if (isMatch) {
                playSound('correct');
                c1.classList.remove('selected'); c2.classList.remove('selected');
                c1.classList.add('matched'); c2.classList.add('matched');
                matchesFound++;
                updateProgress('progressFillGame1', (matchesFound / 5) * 100);
                selectedCards = [];
                if (matchesFound === 5) setTimeout(() => initGame2(), 1000);
            } else {
                playSound('error');
                
                // Feedback visual instant√°neo (sin bloqueo de tiempo)
                c1.classList.remove('selected'); c2.classList.remove('selected');
                c1.classList.add('flash-error'); c2.classList.add('flash-error');
                
                // Limpieza inmediata de las tarjetas seleccionadas para permitir jugar r√°pido
                selectedCards = [];
                
                // Limpieza de la clase de animaci√≥n despu√©s de que termine (300ms)
                setTimeout(() => {
                    c1.classList.remove('flash-error');
                    c2.classList.remove('flash-error');
                }, 300);
            }
        }
    }

    /* --- JUEGO 2 --- */
    let targetsQueue = [];
    let currentIndex = 0;

    function initGame2() {
        showScreen('game2Screen');
        const wrapper = document.getElementById('imageWrapperGame2');
        wrapper.querySelectorAll('.selection-box').forEach(e => e.remove());
        
        const origW = 928, origH = 963;
        game2Targets.forEach(t => {
            const box = document.createElement('div');
            box.className = 'selection-box';
            box.style.left = (t.x1/origW*100) + '%';
            box.style.top = (t.y1/origH*100) + '%';
            box.style.width = ((t.x2-t.x1)/origW*100) + '%';
            box.style.height = ((t.y2-t.y1)/origH*100) + '%';
            box.dataset.id = t.id;
            box.onclick = () => checkZone(box);
            wrapper.appendChild(box);
        });

        targetsQueue = [...game2Targets].sort(() => Math.random() - 0.5);
        currentIndex = 0;
        attemptsGame2 = 0;
        document.getElementById('attemptsGame2').textContent = '0';
        updateProgress('progressFillGame2', 50); 
        document.getElementById('targetDisplay').textContent = `Busca: ${targetsQueue[0].name}`;
    }

    function checkZone(box) {
        attemptsGame2++;
        document.getElementById('attemptsGame2').textContent = attemptsGame2;

        if (box.dataset.id === targetsQueue[currentIndex].id) {
            playSound('correct');
            
            // Animaci√≥n de Flash Verde
            box.classList.add('correct-flash');
            setTimeout(() => {
                box.classList.remove('correct-flash');
            }, 300);

            currentIndex++;
            updateProgress('progressFillGame2', (50 + (currentIndex/5)*50));
            
            if (currentIndex < targetsQueue.length) {
                document.getElementById('targetDisplay').textContent = `Busca: ${targetsQueue[currentIndex].name}`;
            } else {
                setTimeout(finishGame, 500);
            }
        } else {
            playSound('error');
            // Animaci√≥n de Flash Rojo
            box.classList.add('wrong-flash');
            setTimeout(() => {
                box.classList.remove('wrong-flash');
            }, 300);
        }
    }

    function updateProgress(id, pct) {
        document.getElementById(id).style.width = pct + '%';
    }

    /* --- 3. L√ìGICA Y FUNCIONALIDAD JAVASCRIPT --- */
    
    // Variables de control HoF
    let isHofLoading = false;

    function loadHallOfFame() {
        if (isHofLoading) return;
        isHofLoading = true;

        const tbody = document.getElementById('hofTableBody');
        tbody.innerHTML = ''; 

        fetch(`${APP_SCRIPT_URL}?action=read&sheet=${SHEET_NAME}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success' && data.data) {
                    
                    const processedData = data.data.map(row => {
                        const getVal = (keys) => {
                            for(let key of keys) {
                                if(row[key] !== undefined && row[key] !== "") return row[key];
                            }
                            return null;
                        };
                        return {
                            Nombre: getVal(["Nombre", "nombre", "name"]),
                            Apellidos: getVal(["Apellidos", "apellidos", "surname"]),
                            Puntuaci√≥n: getVal(["Puntuaci√≥n", "puntuaci√≥n", "score"]),
                            Tiempo: getVal(["Tiempo", "tiempo", "time"])
                        };
                    });

                    // Filtrar SOLO los que tienen puntuaci√≥n v√°lida (evitar filas vac√≠as de prueba)
                    const validData = processedData.filter(row => row.Puntuaci√≥n !== null && !isNaN(parseFloat(row.Puntuaci√≥n)));

                    if (validData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="hall-of-fame-error">No hay datos v√°lidos.</td></tr>';
                    } else {
                        // Ordenar por Puntuaci√≥n (Desc) y Tiempo (Asc)
                        validData.sort((a, b) => {
                            const scoreA = parseFloat(a.Puntuaci√≥n) || 0;
                            const scoreB = parseFloat(b.Puntuaci√≥n) || 0;
                            if (scoreB !== scoreA) return scoreB - scoreA;
                            const timeA = parseFloat(a.Tiempo) || 9999;
                            const timeB = parseFloat(b.Tiempo) || 9999;
                            return timeA - timeB;
                        });

                        // Seleccionar los 10 mejores (aseguramos que haya 10 si existen)
                        const top10 = validData.slice(0, 10);

                        top10.forEach((item, index) => {
                            const tr = document.createElement('tr');
                            const displayName = `${item.Nombre} ${item.Apellidos}`.trim();
                            
                            let timeStr = item.Tiempo;
                            if (!isNaN(parseFloat(item.Tiempo))) {
                                const tVal = parseFloat(item.Tiempo);
                                const tm = Math.floor(tVal / 60).toString().padStart(2,'0');
                                const ts = Math.floor(tVal % 60).toString().padStart(2,'0');
                                const tms = Math.floor((tVal % 1) * 10);
                                timeStr = `${tm}:${ts}.${tms}`;
                            }
                            const points = item.Puntuaci√≥n || 0;

                            tr.innerHTML = `
                                <td>${index +1}¬∫</td>
                                <td>${displayName}</td>
                                <td>${points}</td>
                                <td>${timeStr}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="hall-of-fame-error">No hay puntuaciones a√∫n.</td></tr>';
                }
            })
            .catch(e => {
                console.error("Error HoF:", e);
                tbody.innerHTML = '<tr><td colspan="4" class="hall-of-fame-error">Error de conexi√≥n.</td></tr>';
            })
            .finally(() => {
                isHofLoading = false;
            });
    }

    function showSubmitModal(time, score) {
        document.getElementById('modalTime').textContent = formatTime(time);
        document.getElementById('playerName').value = '';
        document.getElementById('playerSurname').value = '';
        document.getElementById('submitModal').style.display = 'flex';
    }

    document.getElementById('discardScoreBtn').onclick = () => { 
        document.getElementById('submitModal').style.display = 'none'; 
    };

    document.getElementById('submitScoreBtn').onclick = () => {
        const btn = document.getElementById('submitScoreBtn');
        const nameInput = document.getElementById('playerName');
        const surnameInput = document.getElementById('playerSurname');
        
        const payload = {
            score: parseInt(document.getElementById('finalScore').textContent),
            time: parseFloat(document.getElementById('finalTime').textContent.replace(':','.')),
            name: nameInput.value.trim(),
            surname: surnameInput.value.trim()
        };

        if(payload.name && payload.surname) {
            const originalText = btn.textContent;
            btn.textContent = "ENVIANDO...";
            btn.disabled = true;

            fetch(APP_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ sheet: SHEET_NAME, action: 'write', data: payload })
            })
            .then(() => {
                document.getElementById('submitModal').style.display = 'none';
                btn.textContent = originalText;
                btn.disabled = false;
                setTimeout(loadHallOfFame, 1500);
            })
            .catch(e => {
                console.error("Error env√≠o:", e);
                alert("Error al enviar puntuaci√≥n.");
                btn.textContent = originalText;
                btn.disabled = false;
            });
        } else {
            alert("Por favor, completa ambos campos.");
        }
    };

    /* --- FINALIZAR --- */
    function finishGame() {
        stopTimer();
        const finalTimeVal = (Date.now() - startTime) / 1000;
        
        const eff1 = attemptsGame1 > 0 ? (correctPairsGame1 / attemptsGame1) :0;
        const eff2 = attemptsGame2 > 0 ? (correctPairsGame2 / attemptsGame2) :0;
        const finalScore = Math.round(((eff1 + eff2) / 2) * 100);

        document.getElementById('finalScore').textContent = finalScore;
        document.getElementById('finalTime').textContent = formatTime(finalTimeVal);

        const trophyBox = document.getElementById('trophyBox');
        const msg = document.getElementById('finalMsg');
        
        if (finalScore === 100) {
            trophyBox.style.display = 'block';
            msg.textContent = '¬°Enhorabuena, puntuaci√≥n m√°xima!';
            playSound('victory');
            createConfetti();
        } else {
            trophyBox.style.display = 'none';
            msg.textContent = '¬°Buen trabajo! Sigue practicando';
            playSound('completed');
        }

        showScreen('finalScreen');
        showSubmitModal(finalTimeVal, finalScore);
    }

    /* --- EVENTOS INICIO --- */
    document.getElementById('playBtn').onclick = () => { playSound('tap'); showScreen('summaryScreen'); };
    document.getElementById('startGame1Btn').onclick = () => { playSound('tap'); initGame1(); showScreen('game1Screen'); };
    document.getElementById('backToMenuBtn').onclick = () => { playSound('tap'); location.reload(); };
    document.getElementById('muteBtn').onclick = toggleSound;

    /* --- EFECTOS VISUALES --- */
    function createConfetti() {
        for(let i=0;i<100;i++){
            setTimeout(()=>{
                const c = document.createElement('div');
                c.className = 'confetti';
                const x = Math.random() * window.innerWidth;
                const tx = (Math.random() - 0.5) * 200;
                c.style.left = x + 'px';
                c.style.top = '-10px';
                c.style.backgroundColor = ['#ff595e','#1982c4','#6a4c93','#ffca3a','#8ac926'][Math.floor(Math.random()*5)];
                c.style.setProperty('--tx', tx + 'px');
                c.style.setProperty('--ty', window.innerHeight + 20 + 'px');
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }, i * 20);
        }
    }

    /* --- INIT --- */
    document.addEventListener('DOMContentLoaded', () => { loadHallOfFame(); });
</script>
</body>
</html>
